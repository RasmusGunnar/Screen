<!-- /index.html (RasmusGunnar/test) -->
<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Loader…</title>
  <meta name="robots" content="noindex"/>
  <script>
    (function () {
      // 0) VÆLG DIT FASTE HID HER
      var FIXED_HID = "FAMILIE01"; // <-- skift til dit ønskede HID, kun A-Z/0-9
      // 0) VÆLG DIT FASTE ORGANISATIONS-ID HER
      var FIXED_ORG = "subra"; // <-- skift til dit ønskede ID, kun A-Z/0-9

      // 1) Fjern gamle service workers (forebygger cache-støj)
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
      }

      // 2) Byg mål-URL og T V I N G ?hid=FIXED_HID
      var target = new URL('./webkiosk_apple_crisp_with_settings_fab.html', location.href);
      var target = new URL('./subra_attendance.html', location.href);

      // Bevar evt. eksisterende query/hash, men overstyr hid
      // Bevar evt. eksisterende query/hash, men overstyr org
      var params = new URLSearchParams(location.search);
      params.set('hid', FIXED_HID); // <- altid dit faste HID
      params.set('org', FIXED_ORG); // <- altid dit faste ID
      target.search = '?' + params.toString();
      if (location.hash) target.hash = location.hash;

      // 3) Redirect
      location.replace(target.toString());
    })();
  </script>
  <noscript>
    <meta http-equiv="refresh" content="0; url=./webkiosk_apple_crisp_with_settings_fab.html?hid=FAMILIE01">
    <meta http-equiv="refresh" content="0; url=./subra_attendance.html?org=subra">
  </noscript>
</head>
<body>Åbner Webkiosk…</body>
</html>
subra_attendance.html
Ny
+2684
-0

<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SUBRA | Gæsteregistrering</title>
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./assets/icon-192.png" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Manrope:wght@500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      color-scheme: light;
      --bg: #f5f5f3;
      --panel: rgba(255, 255, 255, 0.72);
      --panel-solid: #ffffff;
      --stroke: rgba(15, 23, 42, 0.12);
      --fg: #0f172a;
      --muted: #475569;
      --accent: #0f172a;
      --accent-soft: rgba(15, 23, 42, 0.08);
      --success: #0ea5e9;
      --success-fg: #0b3d55;
      --danger: #ef4444;
      --leave: #fbbf24;
      --font-base: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      --font-display: "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
      font-size: clamp(15px, 0.9vw + 12px, 18px);
    }

    function populateGuestHosts() {
      if (!guestHostSelect) return;
      const previous = guestHostSelect.value;
      const employees = [...state.employees.values()].sort((a, b) => {
        const dept = a.department.localeCompare(b.department, 'da');
        if (dept !== 0) return dept;
        return a.name.localeCompare(b.name, 'da');
      });
      guestHostSelect.innerHTML = '<option value="">Vælg medarbejder</option>';
      employees.forEach((employee) => {
        const option = document.createElement('option');
        option.value = employee.id;
        option.textContent = `${employee.name} · ${employee.department}`;
        guestHostSelect.appendChild(option);
      });
      if (previous && state.employees.has(previous)) {
        guestHostSelect.value = previous;
      }
    }

    function overviewCard(title, value, description) {
      return `<article class="overview-card"><h4>${title}</h4><strong>${value}</strong><small>${description}</small></article>`;
    }

    function renderOverview() {
      if (!overviewStats) return;
      const employees = [...state.employees.values()];
      const activeVisitors = state.visitors.filter((visitor) => visitor.status !== 'out' && !visitor.checkedOutAt);
      const presentEmployees = employees.filter((employee) => employee.status === 'in' && !(employee.leave && isOnLeave(employee.leave)));
      const leaveEmployees = employees.filter((employee) => employee.leave && isOnLeave(employee.leave));
      const outEmployees = employees.length - presentEmployees.length - leaveEmployees.length;
      const visitorsToday = state.visitors.filter((visitor) => isToday(visitor.checkedInAt));

      if (!employees.length && !state.visitors.length) {
        overviewStats.innerHTML = '<div class="empty-state">Tilføj medarbejdere og registrer besøg for at se overblik her.</div>';
        return;
      }

      const leaveSummary = leaveEmployees.length
        ? leaveEmployees.slice(0, 2).map((employee) => employee.name).join(', ') + (leaveEmployees.length > 2 ? ' +' : '')
        : 'Ingen fravær registreret';

      const activeSummary = `${presentEmployees.length} medarbejdere · ${activeVisitors.length} gæster`;
      const todaySummary = visitorsToday.length
        ? `${visitorsToday.length} besøgende registreret i dag`
        : 'Ingen gæster registreret endnu i dag';
      const visitorDescription = activeVisitors.length
        ? `${todaySummary} <span class="visitor-pill">Gæster til stede</span>`
        : todaySummary;

      overviewStats.innerHTML = [
        overviewCard('I huset lige nu', presentEmployees.length + activeVisitors.length, activeSummary),
        overviewCard('Registrerede besøg i dag', visitorsToday.length, visitorDescription),
        overviewCard('Medarbejdere ude af huset', Math.max(outEmployees, 0), 'Planlagte møder, fjernarbejde m.m.'),
        overviewCard('Fravær & orlov', leaveEmployees.length, leaveSummary),
      ].join('');
    }

    function renderRecentVisitors() {
      if (!recentVisitorsList || !recentVisitorsSection) return;
      const visitors = [...state.visitors]
        .sort((a, b) => {
          const aDate = toDate(a.checkedInAt)?.getTime() || 0;
          const bDate = toDate(b.checkedInAt)?.getTime() || 0;
          return bDate - aDate;
        })
        .slice(0, 4);

      if (!visitors.length) {
        recentVisitorsSection.hidden = true;
        recentVisitorsList.innerHTML = '<div class="empty-state">Ingen besøgende registreret endnu.</div>';
        return;
      }

      recentVisitorsSection.hidden = false;
      const fragment = document.createDocumentFragment();
      visitors.forEach((visitor) => {
        const card = document.createElement('article');
        card.className = 'visitor-card';
        card.innerHTML = `
          <div class="name">${visitor.name}${visitor.company ? ` · ${visitor.company}` : ''}</div>
          <div class="meta">
            <span class="host">Vært: ${visitor.hostName || 'Ukendt'}</span>
            <span>Indtjekket: ${formatDateTime(visitor.checkedInAt)}</span>
            <span>Forventet afgang: ${formatTimeValue(visitor.expectedDeparture)}</span>
          </div>
          <div style="font-size:13px;color:var(--muted);">${visitor.purpose || 'Ingen note'}</div>
        `;
        if (visitor.status !== 'out' && !visitor.checkedOutAt) {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = 'Tjek gæst ud';
          btn.addEventListener('click', () => checkoutVisitor(visitor.id));
          card.appendChild(btn);
        }
        fragment.appendChild(card);
      });
      recentVisitorsList.innerHTML = '';
      recentVisitorsList.appendChild(fragment);
    }

    function renderManagerVisitorList() {
      if (!managerVisitorList) return;
      const visitors = [...state.visitors]
        .sort((a, b) => {
          const aDate = toDate(a.checkedInAt)?.getTime() || 0;
          const bDate = toDate(b.checkedInAt)?.getTime() || 0;
          return bDate - aDate;
        });
      if (!visitors.length) {
        managerVisitorList.innerHTML = '<div class="empty-state">Ingen besøgende registreret endnu.</div>';
        return;
      }
      const fragment = document.createDocumentFragment();
      visitors.forEach((visitor) => {
        const card = document.createElement('article');
        card.className = 'visitor-card manager';
        card.innerHTML = `
          <div class="name">${visitor.name}${visitor.company ? ` · ${visitor.company}` : ''}</div>
          <div class="meta">
            <span>Vært: ${visitor.hostName || 'Ukendt'}</span>
            <span>Ind: ${formatDateTime(visitor.checkedInAt)}</span>
            <span>Ud: ${visitor.checkedOutAt ? formatDateTime(visitor.checkedOutAt) : '—'}</span>
          </div>
          <div style="font-size:13px;color:var(--muted);">${visitor.purpose || 'Ingen note'}${visitor.vehicle ? ` · Bil: ${visitor.vehicle}` : ''}</div>
        `;
        if (visitor.status !== 'out' && !visitor.checkedOutAt) {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = 'Tjek ud';
          btn.addEventListener('click', () => checkoutVisitor(visitor.id));
          card.appendChild(btn);
        }
        fragment.appendChild(card);
      });
      managerVisitorList.innerHTML = '';
      managerVisitorList.appendChild(fragment);
    }

    function renderVisitors() {
      renderRecentVisitors();
      renderManagerVisitorList();
      renderOverview();
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: var(--font-base);
      color: var(--fg);
      background: var(--bg);
      -webkit-font-smoothing: antialiased;
    }

    body {
      display: flex;
      flex-direction: column;
      background: linear-gradient(135deg, #f8fafc 0%, #edf1f5 55%, #f7f5f0 100%);
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: auto;
    }

    button, input, select {
      font: inherit;
    }

    button {
      cursor: pointer;
    }

    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
      white-space: nowrap;
    }

    .screensaver {
      position: relative;
      flex: 1;
      display: grid;
      place-items: center;
      overflow: hidden;
      background: #000;
      color: #fff;
    }

    .slides {
      position: absolute;
      inset: 0;
      display: grid;
    }

    .slide {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      opacity: 0;
      transform: scale(1.05);
      transition: opacity 1s ease, transform 12s linear;
    }

    .slide.is-active {
      opacity: 1;
      transform: scale(1);
      z-index: 2;
    }

    .overlay-top {
      position: absolute;
      top: clamp(16px, 4vw, 40px);
      left: clamp(16px, 4vw, 40px);
      display: inline-flex;
      align-items: center;
      gap: 14px;
      background: rgba(10, 17, 31, 0.55);
      backdrop-filter: blur(8px);
      padding: 14px 18px;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .overlay-top img {
      height: clamp(42px, 6vw, 64px);
      width: auto;
      display: block;
      filter: drop-shadow(0 4px 14px rgba(0, 0, 0, 0.35));
    }

    .overlay-top span {
      font-family: var(--font-display);
      font-size: clamp(22px, 5vw, 38px);
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .overlay-bottom {
      position: absolute;
      left: 50%;
      bottom: clamp(18px, 8vh, 60px);
      transform: translateX(-50%);
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: clamp(18px, 4vw, 32px) clamp(24px, 6vw, 48px);
      background: rgba(10, 17, 31, 0.58);
      border-radius: clamp(18px, 4vw, 36px);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
    }

    .overlay-bottom h1 {
      margin: 0;
      font-family: var(--font-display);
      font-size: clamp(26px, 5vw, 46px);
      letter-spacing: 0.04em;
      font-weight: 700;
    }

    .overlay-bottom p {
      margin: 0;
      font-size: clamp(16px, 2.5vw, 24px);
      color: rgba(255, 255, 255, 0.82);
      max-width: 640px;
    }

    .pulse {
      border-radius: 999px;
      padding: 10px 22px;
      font-weight: 600;
      color: #0f172a;
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      animation: pulse 2.8s ease infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.9; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-4px); }
    }

    .app-shell {
      position: relative;
      flex: 1;
      display: none;
      padding: clamp(20px, 4vw, 48px);
      overflow: auto;
    }

    .app-shell.is-visible {
      display: flex;
      flex-direction: column;
      min-height: 100%;
    }

    .app-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.82);
      backdrop-filter: blur(12px);
      border-radius: clamp(22px, 4vw, 32px);
      box-shadow: 0 34px 66px rgba(15, 23, 42, 0.14);
      border: 1px solid rgba(15, 23, 42, 0.06);
      overflow: hidden;
      min-height: 0;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      padding: clamp(16px, 3vw, 28px) clamp(22px, 4vw, 34px);
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
    }

    .app-header .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .app-header .brand img {
      height: clamp(42px, 5vw, 58px);
    }

    .app-header h2 {
      margin: 0;
      font-family: var(--font-display);
      font-size: clamp(20px, 3vw, 28px);
      letter-spacing: 0.04em;
    }

    .app-header .clock {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      min-width: 140px;
      font-variant-numeric: tabular-nums;
    }

    .clock .time {
      font-size: clamp(22px, 4vw, 38px);
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .clock .date {
      color: var(--muted);
      font-weight: 500;
    }

    .content {
      flex: 1;
      min-height: 0;
      display: grid;
      grid-template-columns: minmax(280px, 340px) 1fr;
    }

    .content > aside {
      padding: clamp(18px, 3vw, 28px);
      border-right: 1px solid rgba(15, 23, 42, 0.06);
      display: flex;
      flex-direction: column;
      gap: 18px;
      background: rgba(255,255,255,0.68);
    }

    .search-box input {
      width: 100%;
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: rgba(255,255,255,0.8);
      font-size: 16px;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .action-buttons button {
      padding: 14px 16px;
      border-radius: 18px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: linear-gradient(145deg, #0f172a, #17233f);
      color: #fff;
      font-weight: 600;
      letter-spacing: 0.04em;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.24);
    }

    .action-buttons button.secondary {
      background: #fff;
      color: var(--fg);
      box-shadow: 0 12px 34px rgba(15, 23, 42, 0.12);
    }

    .content main {
      padding: clamp(18px, 3vw, 32px);
      overflow-y: auto;
      position: relative;
      background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.72));
    }

    .status-legend {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      font-size: 14px;
      color: var(--muted);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.06);
      color: var(--fg);
      font-weight: 600;
    }

    .status-badge::before {
      content: "";
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: currentColor;
      opacity: 0.85;
    }

    .status-badge.present { color: #0ea5e9; }
    .status-badge.out { color: rgba(15,23,42,0.55); }
    .status-badge.leave { color: #f59e0b; }
    .status-badge.sick { color: #ef4444; }
    .department {
      margin-top: clamp(18px, 3vw, 32px);
    }

    .department:first-of-type {
      margin-top: clamp(8px, 2vw, 16px);
    }

    .department h3 {
      margin: 0 0 18px;
      font-family: var(--font-display);
      font-size: clamp(18px, 3vw, 24px);
      letter-spacing: 0.02em;
    }

    .people-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .person {
      display: flex;
      gap: 14px;
      padding: 16px;
      border-radius: 22px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(255,255,255,0.9);
      box-shadow: 0 20px 38px rgba(15, 23, 42, 0.08);
      position: relative;
      overflow: hidden;
    }

    .person.is-present { border-color: rgba(14, 165, 233, 0.45); }
    .person.is-present::after {
      content: "Til stede";
      position: absolute;
      top: 14px;
      right: 16px;
      font-size: 12px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(14, 165, 233, 0.12);
      color: var(--success);
    }

    .person.is-out::after {
      content: "Ude";
      position: absolute;
      top: 14px;
      right: 16px;
      font-size: 12px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.08);
      color: rgba(15, 23, 42, 0.62);
    }

    .person.is-leave::after {
      content: attr(data-leave-label);
      position: absolute;
      top: 14px;
      right: 16px;
      font-size: 12px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(251, 191, 36, 0.18);
      color: #b45309;
      text-transform: capitalize;
    }

    .avatar {
      width: 72px;
      height: 72px;
      border-radius: 22px;
      overflow: hidden;
      flex-shrink: 0;
      background: linear-gradient(135deg, #bfdbfe, #c7d2fe);
      display: grid;
      place-items: center;
      font-weight: 700;
      letter-spacing: 0.04em;
      color: #1e3a8a;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .person .info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .info .name {
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .info .role {
      color: var(--muted);
      font-size: 14px;
    }

    .info .timestamps {
      margin-top: auto;
      font-size: 12px;
      color: var(--muted);
    }

    .person .controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      justify-content: center;
    }

    .controls button {
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15, 23, 42, 0.1);
      background: #fff;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .controls button.primary {
      background: linear-gradient(145deg, #0ea5e9, #0284c7);
      border-color: transparent;
      color: #fff;
      box-shadow: 0 14px 30px rgba(14, 165, 233, 0.35);
    }

    .controls button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }

    .empty-state {
      padding: 60px;
      text-align: center;
      color: var(--muted);
      border-radius: 24px;
      border: 1px dashed rgba(15, 23, 42, 0.12);
      background: rgba(255,255,255,0.7);
    }

    .overview {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      margin-bottom: clamp(18px, 3vw, 32px);
    }

    .overview-card {
      padding: 18px 20px;
      border-radius: 20px;
      background: rgba(255,255,255,0.88);
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.12);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .overview-card h4 {
      margin: 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(15, 23, 42, 0.55);
    }

    .overview-card strong {
      font-family: var(--font-display);
      font-size: clamp(26px, 4vw, 34px);
      font-weight: 700;
    }

    .overview-card small {
      color: var(--muted);
    }

    .recent-visitors {
      margin-top: clamp(24px, 4vw, 40px);
      padding: clamp(18px, 3vw, 26px);
      border-radius: 24px;
      background: rgba(255,255,255,0.84);
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 20px 32px rgba(15, 23, 42, 0.1);
    }

    .recent-visitors header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }

    .recent-visitors h3 {
      margin: 0;
      font-family: var(--font-display);
      font-size: clamp(18px, 3vw, 24px);
    }

    .recent-visitors button {
      border-radius: 14px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: rgba(14, 165, 233, 0.08);
      color: var(--accent);
      font-weight: 600;
      padding: 8px 14px;
    }

    .visitor-list {
      display: grid;
      gap: 12px;
    }

    .visitor-card {
      padding: 16px 18px;
      border-radius: 18px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(255,255,255,0.92);
      display: grid;
      gap: 6px;
    }

    .visitor-card.manager {
      background: rgba(241, 245, 249, 0.9);
      border-style: dashed;
    }

    .visitor-card button {
      justify-self: flex-start;
      padding: 8px 14px;
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: rgba(15, 23, 42, 0.05);
      font-weight: 600;
      font-size: 14px;
    }

    .visitor-card .meta {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      font-size: 14px;
      color: var(--muted);
      flex-wrap: wrap;
    }

    .visitor-card .name {
      font-weight: 600;
      font-size: 16px;
    }

    .visitor-card .host {
      color: var(--accent);
      font-weight: 600;
    }

    .guest-modal .dialog {
      width: min(520px, 92vw);
      max-height: min(720px, 92vh);
    }

    .guest-modal form {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 24px 28px 28px;
      overflow: auto;
    }

    .guest-modal .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .guest-modal label {
      font-weight: 600;
    }

    .guest-modal input,
    .guest-modal select,
    .guest-modal textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: rgba(255,255,255,0.85);
      font-size: 16px;
    }

    .guest-modal textarea {
      resize: vertical;
      min-height: 80px;
    }

    .guest-modal .checkbox {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 14px;
    }

    .guest-modal .checkbox input {
      width: 20px;
      height: 20px;
      margin-top: 4px;
    }

    .guest-modal .actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .guest-modal .actions button {
      flex: 1;
      min-width: 140px;
      padding: 12px 18px;
      border-radius: 16px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      font-weight: 600;
    }

    .guest-modal .actions .primary {
      background: linear-gradient(140deg, #0ea5e9, #22d3ee);
      color: #0b3d55;
      box-shadow: 0 12px 32px rgba(14, 165, 233, 0.3);
    }

    .guest-modal .actions .secondary {
      background: rgba(255,255,255,0.9);
    }

    .visitor-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(14, 165, 233, 0.15);
      color: var(--accent);
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .manager-button {
      margin-top: auto;
      padding: 12px 16px;
      border-radius: 16px;
      border: 1px dashed rgba(15, 23, 42, 0.2);
      background: rgba(255,255,255,0.6);
      font-weight: 600;
    }

    .manager-modal,
    .guest-modal,
    .toast-region {
      position: fixed;
      inset: 0;
      pointer-events: none;
    }

    .manager-modal .backdrop,
    .guest-modal .backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      backdrop-filter: blur(10px);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .manager-modal.is-open .backdrop,
    .guest-modal.is-open .backdrop {
      opacity: 1;
      pointer-events: auto;
    }

    .manager-modal .dialog,
    .guest-modal .dialog {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      width: min(1040px, 94vw);
      max-height: 88vh;
      background: var(--panel-solid);
      border-radius: 28px;
      box-shadow: 0 40px 90px rgba(15, 23, 42, 0.32);
      border: 1px solid rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      opacity: 0;
      transition: transform 0.35s ease, opacity 0.35s ease;
      pointer-events: none;
    }

    .manager-modal.is-open .dialog,
    .guest-modal.is-open .dialog {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
      pointer-events: auto;
    }

    .dialog header {
      padding: 24px 28px 16px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
    }

    .dialog header h3 {
      margin: 0;
      font-family: var(--font-display);
      font-size: 24px;
      letter-spacing: 0.03em;
    }

    .dialog header p {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 14px;
    }

    .dialog .body {
      padding: 24px 28px;
      overflow-y: auto;
      display: grid;
      gap: 24px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .dialog fieldset {
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 20px;
      padding: 18px 20px;
      background: rgba(249, 250, 251, 0.8);
    }

    .dialog fieldset legend {
      font-weight: 700;
      padding: 0 6px;
      letter-spacing: 0.04em;
      font-family: var(--font-display);
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 16px;
    }

    .field label {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .field input, .field select, .field textarea {
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      font-size: 15px;
      background: rgba(255,255,255,0.9);
    }

    .field textarea {
      min-height: 96px;
      resize: vertical;
    }

    .dialog footer {
      padding: 18px 24px;
      border-top: 1px solid rgba(15, 23, 42, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      background: rgba(248,250,252,0.9);
    }

    .dialog footer button {
      padding: 12px 18px;
      border-radius: 14px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: #fff;
      font-weight: 600;
    }

    .dialog footer button.primary {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: #fff;
      border-color: transparent;
    }

    .people-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .people-table th, .people-table td {
      text-align: left;
      padding: 8px 0;
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
    }

    .people-table td.actions {
      text-align: right;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.06);
      font-weight: 600;
      font-size: 12px;
      letter-spacing: 0.02em;
    }

    .toast-region {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      padding: 20px;
      pointer-events: none;
      gap: 10px;
    }

    .toast {
      background: rgba(15, 23, 42, 0.92);
      color: #fff;
      padding: 12px 16px;
      border-radius: 14px;
      box-shadow: 0 18px 36px rgba(15, 23, 42, 0.3);
      font-size: 14px;
      letter-spacing: 0.02em;
      transform: translateY(30px);
      opacity: 0;
      animation: toast-in 0.3s ease forwards;
    }

    @keyframes toast-in {
      to { opacity: 1; transform: translateY(0); }
    }

    .sync-indicator {
      position: fixed;
      left: 24px;
      bottom: 24px;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 18px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .sync-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--muted);
      box-shadow: 0 0 0 6px rgba(148, 163, 184, 0.16);
    }

    .sync-dot.online {
      background: #10b981;
      box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.16);
    }

    .sync-dot.syncing {
      background: #f59e0b;
      box-shadow: 0 0 0 6px rgba(245, 158, 11, 0.16);
      animation: pulse-dot 1.8s ease infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { transform: scale(1); opacity: 0.9; }
      50% { transform: scale(1.2); opacity: 1; }
    }

    @media (max-width: 1100px) {
      .content {
        grid-template-columns: 1fr;
      }
      .content > aside {
        border-right: none;
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
        flex-direction: column;
      }
      .content main {
        padding-top: clamp(12px, 3vw, 24px);
      }
    }

    @media (max-width: 768px) {
      :root { font-size: clamp(14px, 1vw + 12px, 16px); }
      .app-header { flex-direction: column; align-items: flex-start; }
      .app-header .clock { align-items: flex-start; }
      .people-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
      .person { flex-direction: column; }
      .person .controls { flex-direction: row; }
      .overlay-top, .overlay-bottom { left: 16px; right: 16px; transform: none; }
      .overlay-bottom { bottom: 16px; }
    }
  </style>
</head>
<body>
  <section class="screensaver" id="screensaver" role="button" aria-label="Tryk for at registrere">
    <div class="slides" id="slides"></div>
    <div class="overlay-top">
      <img src="./assets/icon-192.png" alt="SUBRA logo" />
      <span>SUBRA</span>
    </div>
    <div class="overlay-bottom">
      <h1>Velkommen til SUBRA</h1>
      <p>Registrer din ankomst og afgang for at give dine kolleger fuldt overblik over, hvem der er i huset.</p>
      <div class="pulse">Tryk for at starte</div>
    </div>
  </section>

  <div class="app-shell" id="appShell" aria-hidden="true">
    <div class="app-card">
      <header class="app-header">
        <div class="brand">
          <img src="./assets/icon-192.png" alt="SUBRA" />
          <div>
            <h2>SUBRA Workforce</h2>
            <p style="margin:0;color:var(--muted);font-size:14px;">Registrer fremmøde &amp; se afdelingers status</p>
          </div>
        </div>
        <div class="clock" aria-live="polite">
          <span class="time" id="clockTime">--:--</span>
          <span class="date" id="clockDate">--</span>
        </div>
      </header>

      <div class="content">
        <aside>
          <div class="search-box">
            <label class="visually-hidden" for="searchInput">Søg medarbejder</label>
            <input type="search" id="searchInput" placeholder="Søg efter navn eller afdeling" autocomplete="off" />
          </div>
          <div class="status-legend" aria-hidden="true">
            <span class="status-badge present">Til stede</span>
            <span class="status-badge out">Ude</span>
            <span class="status-badge leave">Orlov</span>
            <span class="status-badge sick">Sygemeldt</span>
          </div>
          <div class="action-buttons">
            <button type="button" class="secondary" id="backToScreensaver">Tilbage til infoskærm</button>
            <button type="button" id="refreshData">Synkroniser nu</button>
            <button type="button" id="openGuestModal">Registrer gæst</button>
          </div>
          <button type="button" class="manager-button" id="openManager">Afdelingsleder adgang</button>
        </aside>
        <main>
          <section class="overview" id="overviewStats" aria-live="polite"></section>
          <div id="peopleContainer"></div>
          <section class="recent-visitors" id="recentVisitorsSection">
            <header>
              <h3>Seneste besøgende</h3>
              <button type="button" id="openVisitorLog">Vis hele loggen</button>
            </header>
            <div class="visitor-list" id="recentVisitors"></div>
          </section>
        </main>
      </div>
    </div>
  </div>

  <div class="manager-modal" id="managerModal" aria-hidden="true">
    <div class="backdrop" data-close="true"></div>
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="managerTitle">
      <header>
        <h3 id="managerTitle">Afdelingslederpanel</h3>
        <p>Opdater medarbejderprofiler, billeder og fravær – ændringer synkroniseres straks til alle skærme.</p>
      </header>
      <div class="body">
        <fieldset>
          <legend>Legitimér</legend>
          <div class="field">
            <label for="managerPinInput">PIN-kode</label>
            <input type="password" id="managerPinInput" inputmode="numeric" placeholder="••••" />
          </div>
          <button type="button" id="validatePin" class="primary" style="width:100%;">Lås op</button>
          <p id="pinStatus" style="color:var(--muted);font-size:13px;margin-top:8px;">Del PIN-koden sikkert med ansvarlige ledere.</p>
        </fieldset>
        <fieldset data-section="manager" hidden>
          <legend>Redigér medarbejder</legend>
          <form id="employeeForm">
            <input type="hidden" id="employeeId" />
            <div class="field">
              <label for="employeeName">Navn</label>
              <input type="text" id="employeeName" required />
            </div>
            <div class="field">
              <label for="employeeDepartment">Afdeling</label>
              <input type="text" id="employeeDepartment" required />
            </div>
            <div class="field">
              <label for="employeeRole">Titel (valgfrit)</label>
              <input type="text" id="employeeRole" />
            </div>
            <div class="field">
              <label for="employeePhoto">Billed-URL</label>
              <input type="url" id="employeePhoto" placeholder="https://" />
            </div>
            <div class="field">
              <label for="employeeEmail">Email (valgfrit)</label>
              <input type="email" id="employeeEmail" placeholder="leder@subra.dk" />
            </div>
            <div class="field">
              <label for="employeePhone">Telefon (valgfrit)</label>
              <input type="text" id="employeePhone" placeholder="+45 ..." />
            </div>
            <div class="field">
              <label for="employeeNotifyWebhook">Webhook til notifikation (valgfrit)</label>
              <input type="url" id="employeeNotifyWebhook" placeholder="https://hooks.slack.com/..." />
            </div>
            <div class="field">
              <label for="employeeNotes">Noter</label>
              <textarea id="employeeNotes" placeholder="F.eks. adgangsbehov, certificeringer osv."></textarea>
            </div>
            <div class="field">
              <button type="submit" class="primary" style="width:100%;">Gem medarbejder</button>
            </div>
            <div class="field">
              <button type="button" id="deleteEmployee" style="width:100%;background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.4);color:#b91c1c;">Slet medarbejder</button>
            </div>
          </form>
        </fieldset>
        <fieldset data-section="manager" hidden>
          <legend>Planlagt fravær</legend>
          <form id="leaveForm">
            <div class="field">
              <label for="leaveEmployee">Medarbejder</label>
              <select id="leaveEmployee" required></select>
            </div>
            <div class="field">
              <label for="leaveType">Status</label>
              <select id="leaveType" required>
                <option value="sick">Sygemelding</option>
                <option value="parental">Barsel / Orlov</option>
                <option value="vacation">Ferie</option>
              </select>
            </div>
            <div class="field">
              <label for="leaveStart">Fra</label>
              <input type="date" id="leaveStart" required />
            </div>
            <div class="field">
              <label for="leaveEnd">Til</label>
              <input type="date" id="leaveEnd" required />
            </div>
            <div class="field">
              <button type="submit" class="primary" style="width:100%;">Gem fravær</button>
            </div>
            <div class="field">
              <button type="button" id="clearLeave" style="width:100%;background:rgba(14,165,233,0.12);border:1px solid rgba(14,165,233,0.3);color:#0369a1;">Fjern fravær</button>
            </div>
          </form>
        </fieldset>
        <fieldset data-section="manager" hidden style="grid-column:1/-1;">
          <legend>Medarbejdere</legend>
          <div style="max-height:260px;overflow:auto;">
            <table class="people-table" id="employeeTable" aria-live="polite">
              <thead>
                <tr>
                  <th>Navn</th>
                  <th>Afdeling</th>
                  <th>Status</th>
                  <th class="actions">Handling</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </fieldset>
        <fieldset data-section="manager" hidden style="grid-column:1/-1;">
          <legend>Besøgslog &amp; evakuering</legend>
          <p style="margin-top:0;color:var(--muted);font-size:14px;">Få overblik over gæster og generér lister til evakuering eller sikkerhedstjek.</p>
          <div style="max-height:240px;overflow:auto;">
            <div class="visitor-list" id="managerVisitorList"></div>
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:12px;justify-content:flex-end;margin-top:16px;">
            <button type="button" id="downloadEvacuation" class="primary" style="flex:1;min-width:200px;">Evakueringsliste (CSV)</button>
            <button type="button" id="exportVisitorCsv" style="flex:1;min-width:200px;background:rgba(15,23,42,0.06);border:1px solid rgba(15,23,42,0.15);">Eksportér besøgslog</button>
          </div>
        </fieldset>
      </div>
      <footer>
        <span style="color:var(--muted);font-size:13px;">Ændringer synkroniseres via Firebase Cloud Firestore.</span>
        <div style="display:flex;gap:10px;">
          <button type="button" id="closeManager">Luk</button>
        </div>
      </footer>
    </div>
  </div>

  <div class="guest-modal" id="guestModal" aria-hidden="true">
    <div class="backdrop" data-close="true"></div>
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="guestTitle">
      <header>
        <h3 id="guestTitle">Gæsteregistrering</h3>
        <p>Byd gæster velkommen, udskriv badge og underret værten med det samme.</p>
      </header>
      <form id="guestForm">
        <div class="field">
          <label for="guestName">Navn på gæst *</label>
          <input id="guestName" required placeholder="Fornavn Efternavn" autocomplete="off" />
        </div>
        <div class="field">
          <label for="guestCompany">Virksomhed</label>
          <input id="guestCompany" placeholder="Firma/organisation" autocomplete="off" />
        </div>
        <div class="field">
          <label for="guestEmail">Email</label>
          <input id="guestEmail" type="email" placeholder="gæst@firma.dk" autocomplete="off" />
        </div>
        <div class="field">
          <label for="guestPhone">Telefonnummer</label>
          <input id="guestPhone" type="tel" placeholder="+45 12 34 56 78" autocomplete="off" />
        </div>
        <div class="field">
          <label for="guestHost">Hvem besøger gæsten? *</label>
          <select id="guestHost" required></select>
        </div>
        <div class="field">
          <label for="guestPurpose">Formål med besøget</label>
          <textarea id="guestPurpose" placeholder="Eksempel: Workshop, kundemøde, levering..." rows="3"></textarea>
        </div>
        <div class="field">
          <label for="guestDeparture">Forventet afgang</label>
          <input id="guestDeparture" type="time" />
        </div>
        <div class="field">
          <label for="guestVehicle">Bilregistrering</label>
          <input id="guestVehicle" placeholder="AB12345" autocomplete="off" />
        </div>
        <div class="checkbox">
          <input type="checkbox" id="guestNda" />
          <label for="guestNda">Jeg har læst og accepteret SUBRAs gæste- og NDA-politik.</label>
        </div>
        <div class="actions">
          <button type="button" class="secondary" data-close="true">Fortryd</button>
          <button type="submit" class="primary">Registrer besøg</button>
        </div>
        <p style="font-size:12px;color:var(--muted);text-align:center;margin:0;">Oplysninger gemmes sikkert og deles kun med værten.</p>
      </form>
    </div>
  </div>

  <div class="toast-region" id="toastRegion" aria-live="polite" aria-atomic="true"></div>

  <div class="sync-indicator" id="syncIndicator" hidden>
    <span class="sync-dot" id="syncDot"></span>
    <span id="syncText">Synkroniserer…</span>
  </div>

  <template id="slideTemplate">
    <div class="slide">
      <div class="slide-content"></div>
    </div>
  </template>

  <template id="employeeRowTemplate">
    <tr>
      <td data-field="name"></td>
      <td data-field="department"></td>
      <td data-field="status"></td>
      <td class="actions"><button type="button" data-action="edit">Redigér</button></td>
    </tr>
  </template>

  <script>
    const screensaver = document.getElementById('screensaver');
    const appShell = document.getElementById('appShell');
    const slidesContainer = document.getElementById('slides');
    const slideTemplate = document.getElementById('slideTemplate');
    const peopleContainer = document.getElementById('peopleContainer');
    const overviewStats = document.getElementById('overviewStats');
    const recentVisitorsSection = document.getElementById('recentVisitorsSection');
    const recentVisitorsList = document.getElementById('recentVisitors');
    const openVisitorLogBtn = document.getElementById('openVisitorLog');
    const searchInput = document.getElementById('searchInput');
    const backToScreensaverBtn = document.getElementById('backToScreensaver');
    const refreshDataBtn = document.getElementById('refreshData');
    const openManagerBtn = document.getElementById('openManager');
    const openGuestModalBtn = document.getElementById('openGuestModal');
    const managerModal = document.getElementById('managerModal');
    const guestModal = document.getElementById('guestModal');
    const managerPinInput = document.getElementById('managerPinInput');
    const validatePinBtn = document.getElementById('validatePin');
    const pinStatus = document.getElementById('pinStatus');
    const guestForm = document.getElementById('guestForm');
    const guestNameInput = document.getElementById('guestName');
    const guestCompanyInput = document.getElementById('guestCompany');
    const guestEmailInput = document.getElementById('guestEmail');
    const guestPhoneInput = document.getElementById('guestPhone');
    const guestHostSelect = document.getElementById('guestHost');
    const guestPurposeInput = document.getElementById('guestPurpose');
    const guestDepartureInput = document.getElementById('guestDeparture');
    const guestVehicleInput = document.getElementById('guestVehicle');
    const guestNdaInput = document.getElementById('guestNda');
    const employeeForm = document.getElementById('employeeForm');
    const employeeIdInput = document.getElementById('employeeId');
    const employeeNameInput = document.getElementById('employeeName');
    const employeeDepartmentInput = document.getElementById('employeeDepartment');
    const employeeRoleInput = document.getElementById('employeeRole');
    const employeePhotoInput = document.getElementById('employeePhoto');
    const employeeEmailInput = document.getElementById('employeeEmail');
    const employeePhoneInput = document.getElementById('employeePhone');
    const employeeNotifyWebhookInput = document.getElementById('employeeNotifyWebhook');
    const employeeNotesInput = document.getElementById('employeeNotes');
    const deleteEmployeeBtn = document.getElementById('deleteEmployee');
    const leaveForm = document.getElementById('leaveForm');
    const leaveEmployeeSelect = document.getElementById('leaveEmployee');
    const leaveTypeSelect = document.getElementById('leaveType');
    const leaveStartInput = document.getElementById('leaveStart');
    const leaveEndInput = document.getElementById('leaveEnd');
    const clearLeaveBtn = document.getElementById('clearLeave');
    const managerSections = managerModal.querySelectorAll('[data-section="manager"]');
    const employeeTableBody = document.querySelector('#employeeTable tbody');
    const managerVisitorList = document.getElementById('managerVisitorList');
    const toastRegion = document.getElementById('toastRegion');
    const syncIndicator = document.getElementById('syncIndicator');
    const syncDot = document.getElementById('syncDot');
    const syncText = document.getElementById('syncText');
    const closeManagerBtn = document.getElementById('closeManager');
    const downloadEvacuationBtn = document.getElementById('downloadEvacuation');
    const exportVisitorCsvBtn = document.getElementById('exportVisitorCsv');

    const params = new URLSearchParams(location.search);
    const orgId = (params.get('org') || 'subra').toLowerCase();
    const managerPin = params.get('pin') || '2045';

    let inactivityTimer;
    let slideTimer;
    let activeSlide = 0;
    let unlocked = false;
    let unsubscribeEmployees = null;
    let unsubscribeVisitors = null;
    let unsubscribeSlides = null;
    let pendingToast = null;
    let isSyncing = false;

    const defaultSlides = [
      {
        image: 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1600&q=80',
        heading: 'Innovative løsninger',
        body: 'SUBRA skaber digitale oplevelser med fokus på mennesker, æstetik og datadrevne beslutninger.'
      },
      {
        image: 'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=1600&q=80',
        heading: 'Samarbejde & nærvær',
        body: 'Tjek ind når du møder. Så ved kollegerne, hvornår de kan finde dig på kontoret.'
      },
      {
        image: 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=1600&q=80',
        heading: 'Nordisk ro',
        body: 'Vores indgangsparti er designet til at byde gæster velkommen med varme, ro og overskuelighed.'
      }
    ];

    const fallbackEmployees = [
      {
        id: 'emp-ida',
        name: 'Ida Sørensen',
        department: 'Design',
        role: 'Experience Lead',
        photoUrl: 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=600&q=80',
        email: 'ida@subra.dk',
        phone: '+45 28 91 11 22',
        status: 'in',
        lastCheckIn: new Date(Date.now() - 75 * 60 * 1000).toISOString(),
        lastCheckOut: null,
        notifyWebhook: 'https://ntfy.sh/subra-demo-ida'
      },
      {
        id: 'emp-jonas',
        name: 'Jonas Lund',
        department: 'Udvikling',
        role: 'Lead Software Engineer',
        photoUrl: 'https://images.unsplash.com/photo-1531891437562-4301cf35b7e4?auto=format&fit=crop&w=600&q=80',
        email: 'jonas@subra.dk',
        phone: '+45 22 44 66 12',
        status: 'out',
        lastCheckIn: new Date(Date.now() - 22 * 60 * 60 * 1000).toISOString(),
        lastCheckOut: new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString(),
        notifyWebhook: 'https://ntfy.sh/subra-demo-jonas'
      },
      {
        id: 'emp-maja',
        name: 'Maja Kjær',
        department: 'Salg',
        role: 'Client Director',
        photoUrl: 'https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=600&q=80',
        email: 'maja@subra.dk',
        phone: '+45 40 88 32 91',
        status: 'in',
        lastCheckIn: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
        lastCheckOut: null,
        notifyWebhook: 'https://ntfy.sh/subra-demo-maja'
      },
      {
        id: 'emp-emil',
        name: 'Emil Andreasen',
        department: 'Support',
        role: 'CX Specialist',
        photoUrl: 'https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=600&q=80',
        email: 'emil@subra.dk',
        phone: '+45 33 92 55 08',
        status: 'out',
        lastCheckIn: new Date(Date.now() - 4 * 60 * 60 * 1000).toISOString(),
        lastCheckOut: new Date(Date.now() - 90 * 60 * 1000).toISOString(),
        notifyWebhook: 'https://ntfy.sh/subra-demo-emil',
        leave: {
          type: 'sick',
          start: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
          end: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString()
        }
      },
      {
        id: 'emp-liva',
        name: 'Liva Madsen',
        department: 'Ledelse',
        role: 'COO',
        photoUrl: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=600&q=80',
        email: 'liva@subra.dk',
        phone: '+45 26 40 44 00',
        status: 'out',
        lastCheckIn: null,
        lastCheckOut: new Date(Date.now() - 12 * 60 * 60 * 1000).toISOString(),
        notifyWebhook: 'https://ntfy.sh/subra-demo-liva'
      }
    ];

    const fallbackVisitors = [
      {
        id: 'visit-1',
        name: 'Martin Holm',
        company: 'Nordwind A/S',
        hostId: 'emp-jonas',
        hostName: 'Jonas Lund',
        hostDepartment: 'Udvikling',
        phone: '+45 20 88 10 55',
        email: 'martin@nordwind.dk',
        purpose: 'Workshop om integrationsplatform',
        checkedInAt: new Date(Date.now() - 60 * 60 * 1000).toISOString(),
        checkedOutAt: null,
        expectedDeparture: '15:00',
        ndaAccepted: true,
        vehicle: 'CT45876',
        status: 'in'
      },
      {
        id: 'visit-2',
        name: 'Camilla Kragh',
        company: 'Arctic Foods',
        hostId: 'emp-maja',
        hostName: 'Maja Kjær',
        hostDepartment: 'Salg',
        phone: '+45 61 44 90 30',
        email: 'ck@arcticfoods.dk',
        purpose: 'Kontraktsignering',
        checkedInAt: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(),
        checkedOutAt: new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString(),
        expectedDeparture: '11:30',
        ndaAccepted: true,
        vehicle: null,
        status: 'out'
      }
    ];

    const STORAGE_KEY = 'subra-kiosk-state-v2';
    const supportsStorage = (() => {
      try {
        const key = '__storage_test__';
        localStorage.setItem(key, '1');
        localStorage.removeItem(key);
        return true;
      } catch (error) {
        console.warn('Local storage ikke tilgængelig', error);
        return false;
      }
    })();

    const state = {
      employees: new Map(),
      slides: defaultSlides,
      visitors: [],
    };

    function toDate(value) {
      if (!value) return null;
      if (value instanceof Date) return value;
      if (typeof value === 'string') {
        const parsed = new Date(value);
        return isNaN(parsed) ? null : parsed;
      }
      if (typeof value === 'number') return new Date(value);
      if (value.toDate) return value.toDate();
      if (typeof value.seconds === 'number') return new Date(value.seconds * 1000);
      return null;
    }

    function toIso(value) {
      const date = toDate(value);
      return date ? date.toISOString() : null;
    }

    function normaliseLeave(raw) {
      if (!raw) return null;
      return {
        type: raw.type || 'leave',
        start: toDate(raw.start),
        end: toDate(raw.end),
      };
    }

    function normaliseEmployee(raw) {
      if (!raw) return null;
      const id = raw.id || raw.uid || `emp-${Math.random().toString(16).slice(2)}`;
      return {
        id,
        name: raw.name || 'Ukendt medarbejder',
        department: raw.department || 'Andet',
        role: raw.role || '',
        photoUrl: raw.photoUrl || raw.avatar || '',
        email: raw.email || '',
        phone: raw.phone || raw.mobile || '',
        notes: raw.notes || '',
        status: raw.status === 'in' ? 'in' : 'out',
        lastCheckIn: toDate(raw.lastCheckIn),
        lastCheckOut: toDate(raw.lastCheckOut),
        updatedAt: toDate(raw.updatedAt) || new Date(),
        leave: normaliseLeave(raw.leave),
        notifyWebhook: raw.notifyWebhook || raw.notificationWebhook || '',
      };
    }

    function normaliseVisitor(raw) {
      if (!raw) return null;
      const id = raw.id || raw.uid || `visit-${Math.random().toString(16).slice(2)}`;
      return {
        id,
        name: raw.name || 'Ukendt gæst',
        company: raw.company || '',
        hostId: raw.hostId || '',
        hostName: raw.hostName || '',
        hostDepartment: raw.hostDepartment || '',
        phone: raw.phone || '',
        email: raw.email || '',
        purpose: raw.purpose || '',
        checkedInAt: toDate(raw.checkedInAt) || toDate(raw.createdAt) || new Date(),
        checkedOutAt: toDate(raw.checkedOutAt),
        expectedDeparture: raw.expectedDeparture || '',
        vehicle: raw.vehicle || '',
        ndaAccepted: Boolean(raw.ndaAccepted),
        status: raw.status === 'out' ? 'out' : raw.checkedOutAt ? 'out' : 'in',
        badge: raw.badge || raw.badgeNumber || '',
        createdAt: toDate(raw.createdAt) || new Date(),
      };
    }

    function loadLocalState() {
      const base = {
        employees: fallbackEmployees,
        visitors: fallbackVisitors,
      };
      if (!supportsStorage) return base;
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return base;
        const parsed = JSON.parse(stored);
        return {
          employees: Array.isArray(parsed.employees) && parsed.employees.length ? parsed.employees : fallbackEmployees,
          visitors: Array.isArray(parsed.visitors) ? parsed.visitors : fallbackVisitors,
        };
      } catch (error) {
        console.warn('Kunne ikke læse lokal data', error);
        return base;
      }
    }

    function persistLocalState() {
      if (!supportsStorage) return;
      const payload = {
        employees: [...state.employees.values()].map((employee) => ({
          ...employee,
          lastCheckIn: toIso(employee.lastCheckIn),
          lastCheckOut: toIso(employee.lastCheckOut),
          leave: employee.leave ? {
            ...employee.leave,
            start: toIso(employee.leave.start),
            end: toIso(employee.leave.end),
          } : null,
          updatedAt: toIso(employee.updatedAt),
        })),
        visitors: state.visitors.map((visitor) => ({
          ...visitor,
          checkedInAt: toIso(visitor.checkedInAt),
          checkedOutAt: toIso(visitor.checkedOutAt),
          createdAt: toIso(visitor.createdAt),
        })),
      };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      } catch (error) {
        console.warn('Kunne ikke gemme lokal data', error);
      }
    }

    function hydrateFromLocal() {
      const local = loadLocalState();
      const employees = local.employees.map(normaliseEmployee).filter(Boolean);
      state.employees = new Map(employees.map((employee) => [employee.id, employee]));
      state.visitors = local.visitors.map(normaliseVisitor).filter(Boolean);
    }

    function formatDate(ts) {
      if (!ts) return '—';
      const date = ts instanceof Date ? ts : ts.toDate ? ts.toDate() : new Date(ts);
      return date.toLocaleDateString('da-DK', { day: '2-digit', month: 'long' });
    }

    function formatDateTime(ts) {
      if (!ts) return '—';
      const date = ts instanceof Date ? ts : ts.toDate ? ts.toDate() : new Date(ts);
      const time = date.toLocaleTimeString('da-DK', { hour: '2-digit', minute: '2-digit' });
      return `${date.toLocaleDateString('da-DK')} kl. ${time}`;
    }

    function formatTimeValue(value) {
      if (!value) return '—';
      if (typeof value === 'string' && /^\d{2}:\d{2}$/.test(value)) return value;
      const date = toDate(value);
      if (!date) return '—';
      return date.toLocaleTimeString('da-DK', { hour: '2-digit', minute: '2-digit' });
    }

    function initials(name) {
      return name.split(/\s+/).filter(Boolean).map(part => part[0]).slice(0, 2).join('').toUpperCase();
    }

    function toast(message) {
      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = message;
      toastRegion.appendChild(el);
      if (pendingToast) {
        clearTimeout(pendingToast);
      }
      pendingToast = setTimeout(() => {
        el.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        el.style.opacity = '0';
        el.style.transform = 'translateY(30px)';
        setTimeout(() => el.remove(), 400);
      }, 3200);
    }

    function setSyncState(state) {
      isSyncing = state === 'syncing';
      syncIndicator.hidden = false;
      syncDot.className = 'sync-dot';
      syncDot.style.background = '';
      syncDot.style.boxShadow = '';
      syncText.textContent = {
        syncing: 'Synkroniserer…',
        online: 'Online og opdateret',
        offline: 'Offline – ændringer gemmes lokalt',
        error: 'Fejl i synkronisering'
      }[state] || 'Status ukendt';
      if (state === 'syncing') {
        syncDot.classList.add('syncing');
      } else if (state === 'online') {
        syncDot.classList.add('online');
      } else if (state === 'error') {
        syncDot.style.background = '#ef4444';
        syncDot.style.boxShadow = '0 0 0 6px rgba(239,68,68,0.16)';
      }
      if (state === 'online') {
        setTimeout(() => { syncIndicator.hidden = true; }, 2500);
      }
    }

    function buildSlides(slides) {
      slidesContainer.innerHTML = '';
      slides.forEach((slide, index) => {
        const el = slideTemplate.content.firstElementChild.cloneNode(true);
        el.style.backgroundImage = `linear-gradient(180deg, rgba(15,23,42,0.25), rgba(15,23,42,0.6)), url(${slide.image})`;
        el.innerHTML = `
          <div style="position:absolute;inset:0;display:flex;flex-direction:column;justify-content:flex-end;padding:clamp(24px,6vw,48px);color:#fff;">
            <span style="text-transform:uppercase;letter-spacing:0.4em;font-size:12px;font-weight:600;opacity:0.7;">${slide.tag || 'SUBRA'}</span>
            <h2 style="margin:12px 0 8px;font-family:var(--font-display);font-size:clamp(32px,6vw,56px);">${slide.heading}</h2>
            <p style="margin:0;font-size:clamp(16px,3vw,24px);max-width:600px;opacity:0.88;">${slide.body}</p>
          </div>`;
        if (index === 0) {
          el.classList.add('is-active');
        }
        slidesContainer.appendChild(el);
      });
      activeSlide = 0;
      if (slideTimer) clearInterval(slideTimer);
      slideTimer = setInterval(() => {
        const slidesEls = [...slidesContainer.children];
        if (!slidesEls.length) return;
        slidesEls.forEach((el, idx) => el.classList.toggle('is-active', idx === activeSlide));
        activeSlide = (activeSlide + 1) % slidesEls.length;
      }, 10000);
    }

    function renderEmployees() {
      const query = (searchInput.value || '').trim().toLowerCase();
      const groups = new Map();
      [...state.employees.values()].forEach((employee) => {
        if (query && !(`${employee.name} ${employee.department}`.toLowerCase().includes(query))) return;
        if (!groups.has(employee.department)) groups.set(employee.department, []);
        groups.get(employee.department).push(employee);
      });

      const sortedDepartments = [...groups.keys()].sort((a, b) => a.localeCompare(b, 'da'));
      if (!sortedDepartments.length) {
        peopleContainer.innerHTML = '<div class="empty-state">Ingen medarbejdere fundet – tilføj dem via Afdelingslederpanelet.</div>';
        return;
      }

      const fragment = document.createDocumentFragment();
      sortedDepartments.forEach((dept) => {
        const section = document.createElement('section');
        section.className = 'department';
        section.innerHTML = `<h3>${dept}</h3>`;
        const grid = document.createElement('div');
        grid.className = 'people-grid';
        const sortedPeople = groups.get(dept).sort((a, b) => a.name.localeCompare(b.name, 'da'));
        sortedPeople.forEach((person) => {
          const card = document.createElement('article');
          card.className = 'person';
          if (person.leave && isOnLeave(person.leave)) {
            card.classList.add('is-leave');
            card.dataset.leaveLabel = leaveLabel(person.leave);
          } else if (person.status === 'in') {
            card.classList.add('is-present');
          } else {
            card.classList.add('is-out');
          }

          const avatar = document.createElement('div');
          avatar.className = 'avatar';
          if (person.photoUrl) {
            avatar.innerHTML = `<img src="${person.photoUrl}" alt="${person.name}" onerror="this.remove();this.parentElement.textContent='${initials(person.name)}';" />`;
          } else {
            avatar.textContent = initials(person.name);
          }

          const info = document.createElement('div');
          info.className = 'info';
          info.innerHTML = `
            <div>
              <div class="name">${person.name}</div>
              <div class="role">${person.role || ''}</div>
            </div>
            <div class="timestamps">
              <div>Sidst tjekket ind: ${formatDateTime(person.lastCheckIn)}</div>
              <div>Sidst tjekket ud: ${formatDateTime(person.lastCheckOut)}</div>
            </div>`;

          const controls = document.createElement('div');
          controls.className = 'controls';
          const checkInBtn = document.createElement('button');
          checkInBtn.type = 'button';
          checkInBtn.textContent = 'Tjek ind';
          checkInBtn.classList.add('primary');
          checkInBtn.disabled = person.status === 'in' || (person.leave && isOnLeave(person.leave));
          checkInBtn.addEventListener('click', () => updateAttendance(person.id, 'in'));

          const checkOutBtn = document.createElement('button');
          checkOutBtn.type = 'button';
          checkOutBtn.textContent = 'Tjek ud';
          checkOutBtn.disabled = person.status === 'out' || (person.leave && isOnLeave(person.leave));
          checkOutBtn.addEventListener('click', () => updateAttendance(person.id, 'out'));

          controls.append(checkInBtn, checkOutBtn);

          card.append(avatar, info, controls);
          grid.append(card);
        });
        section.append(grid);
        fragment.append(section);
      });
      peopleContainer.innerHTML = '';
      peopleContainer.appendChild(fragment);
      populateGuestHosts();
      renderOverview();
    }

    function leaveLabel(leave) {
      if (!leave) return '';
      const typeMap = {
        sick: 'Sygemeldt',
        parental: 'Barsel',
        vacation: 'På ferie'
      };
      const label = typeMap[leave.type] || 'Orlov';
      if (!leave.start && !leave.end) return label;
      const start = leave.start ? formatDate(leave.start) : '';
      const end = leave.end ? formatDate(leave.end) : '';
      if (start && end) return `${label} · ${start} – ${end}`;
      return `${label} · ${start || end}`;
    }

    function isOnLeave(leave) {
      if (!leave) return false;
      const today = new Date();
      today.setHours(0,0,0,0);
      const start = leave.start ? (leave.start.toDate ? leave.start.toDate() : new Date(leave.start)) : null;
      const end = leave.end ? (leave.end.toDate ? leave.end.toDate() : new Date(leave.end)) : null;
      if (start) start.setHours(0,0,0,0);
      if (end) end.setHours(23,59,59,999);
      if (start && today < start) return false;
      if (end && today > end) return false;
      return true;
    }

    function isToday(date) {
      const value = toDate(date);
      if (!value) return false;
      const today = new Date();
      return value.getDate() === today.getDate() && value.getMonth() === today.getMonth() && value.getFullYear() === today.getFullYear();
    }

    function showApp() {
      screensaver.hidden = true;
      screensaver.setAttribute('aria-hidden', 'true');
      appShell.classList.add('is-visible');
      appShell.setAttribute('aria-hidden', 'false');
      resetInactivityTimer();
    }

    function showScreensaver() {
      appShell.classList.remove('is-visible');
      appShell.setAttribute('aria-hidden', 'true');
      screensaver.hidden = false;
      screensaver.setAttribute('aria-hidden', 'false');
      clearTimeout(inactivityTimer);
    }

    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        showScreensaver();
      }, 90_000);
    }

    function handleInteraction() {
      if (!appShell.classList.contains('is-visible')) {
        showApp();
      } else {
        resetInactivityTimer();
      }
    }

    screensaver.addEventListener('click', showApp);
    document.addEventListener('pointerdown', handleInteraction);
    document.addEventListener('keydown', handleInteraction);
    backToScreensaverBtn.addEventListener('click', showScreensaver);
    searchInput.addEventListener('input', () => {
      renderEmployees();
      resetInactivityTimer();
    });
    openGuestModalBtn.addEventListener('click', () => {
      openGuestModal();
      resetInactivityTimer();
    });
    openVisitorLogBtn.addEventListener('click', () => {
      openManagerModal();
      toast('Indtast PIN for at se hele besøgsloggen.');
    });

    function openManagerModal() {
      managerModal.classList.add('is-open');
      managerModal.setAttribute('aria-hidden', 'false');
      managerPinInput.focus();
    }

    function closeManagerModal() {
      managerModal.classList.remove('is-open');
      managerModal.setAttribute('aria-hidden', 'true');
      unlocked = false;
      managerSections.forEach((section) => section.hidden = true);
      managerPinInput.value = '';
      pinStatus.textContent = 'Del PIN-koden sikkert med ansvarlige ledere.';
    }

    function openGuestModal() {
      guestModal.classList.add('is-open');
      guestModal.setAttribute('aria-hidden', 'false');
      populateGuestHosts();
      setTimeout(() => guestNameInput.focus(), 50);
    }

    function closeGuestModal() {
      guestModal.classList.remove('is-open');
      guestModal.setAttribute('aria-hidden', 'true');
      guestForm.reset();
      populateGuestHosts();
    }

    openManagerBtn.addEventListener('click', () => {
      openManagerModal();
      resetInactivityTimer();
    });
    managerModal.querySelector('.backdrop').addEventListener('click', closeManagerModal);
    closeManagerBtn.addEventListener('click', closeManagerModal);
    guestModal.addEventListener('click', (event) => {
      if (event.target.dataset.close === 'true') {
        closeGuestModal();
      }
    });
    guestModal.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeGuestModal();
      }
    });
    managerPinInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        validatePinBtn.click();
      }
    });

    validatePinBtn.addEventListener('click', () => {
      if (managerPinInput.value === managerPin) {
        unlocked = true;
        managerSections.forEach((section) => section.hidden = false);
        pinStatus.textContent = 'Adgang givet. Du kan nu opdatere oplysninger.';
        toast('Afdelingslederpanelet er låst op.');
        refreshManagerLists();
      } else {
        unlocked = false;
        managerSections.forEach((section) => section.hidden = true);
        pinStatus.textContent = 'Forkert PIN-kode. Prøv igen eller kontakt administrator.';
        toast('PIN-koden var ikke korrekt.');
      }
    });

    managerModal.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeManagerModal();
      }
    });

    function refreshManagerLists() {
      const employees = [...state.employees.values()].sort((a, b) => a.name.localeCompare(b.name, 'da'));
      leaveEmployeeSelect.innerHTML = '<option value="">Vælg medarbejder</option>';
      employeeTableBody.innerHTML = '';
      employees.forEach((employee) => {
        const option = document.createElement('option');
        option.value = employee.id;
        option.textContent = `${employee.name} · ${employee.department}`;
        leaveEmployeeSelect.appendChild(option);

        const row = document.getElementById('employeeRowTemplate').content.firstElementChild.cloneNode(true);
        row.dataset.id = employee.id;
        row.querySelector('[data-field="name"]').textContent = employee.name;
        row.querySelector('[data-field="department"]').textContent = employee.department;
        row.querySelector('[data-field="status"]').innerHTML = `<span class="pill">${employee.status === 'in' ? 'Til stede' : 'Ude'}</span>`;
        row.querySelector('[data-action="edit"]').addEventListener('click', () => populateEmployeeForm(employee));
        employeeTableBody.appendChild(row);
      });
      renderManagerVisitorList();
      populateGuestHosts();
    }

    function populateEmployeeForm(employee) {
      employeeIdInput.value = employee.id;
      employeeNameInput.value = employee.name;
      employeeDepartmentInput.value = employee.department;
      employeeRoleInput.value = employee.role || '';
      employeePhotoInput.value = employee.photoUrl || '';
      employeeEmailInput.value = employee.email || '';
      employeePhoneInput.value = employee.phone || '';
      employeeNotifyWebhookInput.value = employee.notifyWebhook || '';
      employeeNotesInput.value = employee.notes || '';
    }

    function clearEmployeeForm() {
      employeeForm.reset();
      employeeIdInput.value = '';
    }

    guestForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const name = guestNameInput.value.trim();
      if (!name) {
        toast('Angiv gæstens navn.');
        return;
      }
      if (!guestHostSelect.value) {
        toast('Vælg den medarbejder gæsten besøger.');
        return;
      }
      const host = state.employees.get(guestHostSelect.value);
      if (!host) {
        toast('Vælg en gyldig vært.');
        return;
      }
      const now = new Date();
      const visitor = normaliseVisitor({
        id: `visit-${Date.now()}`,
        name,
        company: guestCompanyInput.value.trim(),
        phone: guestPhoneInput.value.trim(),
        email: guestEmailInput.value.trim(),
        purpose: guestPurposeInput.value.trim(),
        hostId: host.id,
        hostName: host.name,
        hostDepartment: host.department,
        expectedDeparture: guestDepartureInput.value,
        vehicle: guestVehicleInput.value.trim(),
        ndaAccepted: guestNdaInput.checked,
        status: 'in',
        checkedInAt: now,
        createdAt: now,
      });
      state.visitors = [visitor, ...state.visitors];
      renderVisitors();
      persistLocalState();
      try {
        setSyncState('syncing');
        if (window.db) {
          const docRef = window.db.collection('companies').doc(orgId).collection('visitors').doc();
          await docRef.set({
            name: visitor.name,
            company: visitor.company,
            phone: visitor.phone,
            email: visitor.email,
            purpose: visitor.purpose,
            hostId: visitor.hostId,
            hostName: visitor.hostName,
            hostDepartment: visitor.hostDepartment,
            expectedDeparture: visitor.expectedDeparture || null,
            vehicle: visitor.vehicle || null,
            ndaAccepted: visitor.ndaAccepted,
            status: 'in',
            checkedInAt: window.firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: window.firebase.firestore.FieldValue.serverTimestamp(),
          });
          visitor.id = docRef.id;
          persistLocalState();
          setSyncState('online');
        } else {
          setSyncState('offline');
        }
        await notifyHost(host, visitor);
        toast('Gæsten er registreret. Værten er informeret.');
        closeGuestModal();
      } catch (error) {
        console.error(error);
        toast('Kunne ikke registrere gæsten.');
        setSyncState('error');
      }
    });

    employeeForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!unlocked) return;
      const payload = {
        name: employeeNameInput.value.trim(),
        department: employeeDepartmentInput.value.trim(),
        role: employeeRoleInput.value.trim(),
        photoUrl: employeePhotoInput.value.trim(),
        email: employeeEmailInput.value.trim(),
        phone: employeePhoneInput.value.trim(),
        notifyWebhook: employeeNotifyWebhookInput.value.trim(),
        notes: employeeNotesInput.value.trim(),
        updatedAt: new Date(),
      };
      try {
        setSyncState('syncing');
        if (employeeIdInput.value) {
          await saveEmployee(employeeIdInput.value, payload);
          toast('Medarbejderen er opdateret.');
        } else {
          await createEmployee(payload);
          toast('Medarbejderen er oprettet.');
        }
        clearEmployeeForm();
        refreshManagerLists();
        setSyncState('online');
      } catch (error) {
        console.error(error);
        toast('Der opstod en fejl ved gem.');
        setSyncState('error');
      }
    });

    deleteEmployeeBtn.addEventListener('click', async () => {
      if (!unlocked || !employeeIdInput.value) return;
      if (!confirm('Er du sikker på, at du vil slette denne medarbejder?')) return;
      try {
        setSyncState('syncing');
        await deleteEmployee(employeeIdInput.value);
        toast('Medarbejderen er slettet.');
        clearEmployeeForm();
        refreshManagerLists();
        setSyncState('online');
      } catch (error) {
        console.error(error);
        toast('Kunne ikke slette medarbejderen.');
        setSyncState('error');
      }
    });

    leaveForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!unlocked) return;
      if (!leaveEmployeeSelect.value) {
        toast('Vælg en medarbejder.');
        return;
      }
      const payload = {
        type: leaveTypeSelect.value,
        start: leaveStartInput.value ? new Date(leaveStartInput.value) : null,
        end: leaveEndInput.value ? new Date(leaveEndInput.value) : null,
      };
      try {
        setSyncState('syncing');
        await updateLeave(leaveEmployeeSelect.value, payload);
        toast('Fravær registreret.');
        setSyncState('online');
      } catch (error) {
        console.error(error);
        toast('Kunne ikke gemme fravær.');
        setSyncState('error');
      }
    });

    clearLeaveBtn.addEventListener('click', async () => {
      if (!unlocked || !leaveEmployeeSelect.value) return;
      try {
        setSyncState('syncing');
        await updateLeave(leaveEmployeeSelect.value, null);
        toast('Fravær fjernet.');
        setSyncState('online');
      } catch (error) {
        console.error(error);
        toast('Kunne ikke fjerne fravær.');
        setSyncState('error');
      }
    });

    refreshDataBtn.addEventListener('click', () => {
      setSyncState('syncing');
      detachRealtime();
      attachRealtime();
    });

    if (downloadEvacuationBtn) {
      downloadEvacuationBtn.addEventListener('click', () => {
        const rows = [[
          'Navn',
          'Type',
          'Afdeling/Vært',
          'Telefon',
          'Senest registreret'
        ]];
        const presentEmployees = getPresentEmployees();
        presentEmployees.forEach((employee) => {
          rows.push([
            employee.name,
            'Medarbejder',
            employee.department,
            employee.phone || '',
            formatDateTime(employee.lastCheckIn || employee.updatedAt)
          ]);
        });
        const activeVisitors = getVisitorsInHouse();
        activeVisitors.forEach((visitor) => {
          rows.push([
            visitor.name,
            'Gæst',
            visitor.hostName ? `${visitor.hostName} (${visitor.hostDepartment})` : '',
            visitor.phone || '',
            formatDateTime(visitor.checkedInAt)
          ]);
        });
        if (rows.length === 1) {
          toast('Ingen personer registreret i huset lige nu.');
          return;
        }
        const filename = `subra-evakuering-${new Date().toISOString().slice(0, 10)}.csv`;
        downloadCsv(filename, rows);
        toast('Evakueringsliste downloadet.');
      });
    }

    if (exportVisitorCsvBtn) {
      exportVisitorCsvBtn.addEventListener('click', () => {
        const rows = [[
          'Navn',
          'Virksomhed',
          'Vært',
          'Indtjekket',
          'Udtjekket',
          'Telefon',
          'Email',
          'Formål',
          'Status'
        ]];
        if (!state.visitors.length) {
          toast('Ingen besøgende registreret endnu.');
          return;
        }
        const visitors = [...state.visitors].sort((a, b) => {
          const aDate = toDate(a.checkedInAt)?.getTime() || 0;
          const bDate = toDate(b.checkedInAt)?.getTime() || 0;
          return bDate - aDate;
        });
        visitors.forEach((visitor) => {
          rows.push([
            visitor.name,
            visitor.company || '',
            visitor.hostName || '',
            formatDateTime(visitor.checkedInAt),
            visitor.checkedOutAt ? formatDateTime(visitor.checkedOutAt) : '',
            visitor.phone || '',
            visitor.email || '',
            visitor.purpose || '',
            visitor.status === 'out' || visitor.checkedOutAt ? 'Udtjekket' : 'Til stede'
          ]);
        });
        const filename = `subra-besogslog-${new Date().toISOString().slice(0, 10)}.csv`;
        downloadCsv(filename, rows);
        toast('Besøgsloggen er downloadet.');
      });
    }

    function detachRealtime() {
      if (unsubscribeEmployees) unsubscribeEmployees();
      if (unsubscribeVisitors) unsubscribeVisitors();
      if (unsubscribeSlides) unsubscribeSlides();
    }

    function attachRealtime() {
      if (!window.db) {
        setSyncState('offline');
        return;
      }
      setSyncState('syncing');
      unsubscribeEmployees = window.db.collection('companies').doc(orgId).collection('employees').onSnapshot((snapshot) => {
        setSyncState('online');
        const employees = snapshot.docs.map((doc) => normaliseEmployee({ id: doc.id, ...doc.data() })).filter(Boolean);
        state.employees = new Map(employees.map((employee) => [employee.id, employee]));
        renderEmployees();
        if (unlocked) refreshManagerLists();
        persistLocalState();
      }, (error) => {
        console.error(error);
        setSyncState('error');
        toast('Realtime-synk fejlede.');
      });

      unsubscribeVisitors = window.db.collection('companies').doc(orgId).collection('visitors').orderBy('checkedInAt', 'desc').limit(200).onSnapshot((snapshot) => {
        const visitors = snapshot.docs.map((doc) => normaliseVisitor({ id: doc.id, ...doc.data() })).filter(Boolean);
        state.visitors = visitors;
        renderVisitors();
        if (unlocked) refreshManagerLists();
        persistLocalState();
      }, (error) => {
        console.error(error);
      });

      unsubscribeSlides = window.db.collection('companies').doc(orgId).collection('slides').onSnapshot((snapshot) => {
        const slides = snapshot.docs.map((doc) => doc.data()).filter(Boolean);
        if (slides.length) {
          state.slides = slides;
          buildSlides(slides);
        } else {
          state.slides = defaultSlides;
          buildSlides(defaultSlides);
        }
      }, () => {
        state.slides = defaultSlides;
        buildSlides(defaultSlides);
      });
    }

    async function updateAttendance(id, action) {
      const employee = state.employees.get(id);
      if (!employee) {
        toast('Medarbejderen blev ikke fundet.');
        return;
      }
      const now = new Date();
      const next = { ...employee, status: action === 'in' ? 'in' : 'out', updatedAt: now };
      if (action === 'in') {
        next.lastCheckIn = now;
      } else {
        next.lastCheckOut = now;
      }
      state.employees.set(id, next);
      renderEmployees();
      persistLocalState();
      try {
        setSyncState('syncing');
        if (window.db) {
          const updates = {
            status: action === 'in' ? 'in' : 'out',
            updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
          };
          if (action === 'in') {
            updates.lastCheckIn = window.firebase.firestore.FieldValue.serverTimestamp();
          } else {
            updates.lastCheckOut = window.firebase.firestore.FieldValue.serverTimestamp();
          }
          await window.db.collection('companies').doc(orgId).collection('employees').doc(id).set(updates, { merge: true });
          setSyncState('online');
        } else {
          setSyncState('offline');
        }
        toast(action === 'in' ? 'Velkommen! Du er tjekket ind.' : 'Farvel! Du er tjekket ud.');
      } catch (error) {
        console.error(error);
        toast('Kunne ikke opdatere status.');
        setSyncState('error');
      }
    }

    async function createEmployee(payload) {
      const now = new Date();
      try {
        if (window.db) {
          const docRef = window.db.collection('companies').doc(orgId).collection('employees').doc();
          const employee = normaliseEmployee({ id: docRef.id, ...payload, status: 'out', updatedAt: now });
          state.employees.set(employee.id, employee);
          renderEmployees();
          persistLocalState();
          await docRef.set({
            ...payload,
            status: 'out',
            createdAt: window.firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
          });
        } else {
          const employee = normaliseEmployee({ id: `emp-${Date.now()}`, ...payload, status: 'out', updatedAt: now });
          state.employees.set(employee.id, employee);
          renderEmployees();
          persistLocalState();
          setSyncState('offline');
        }
      } catch (error) {
        console.error(error);
        toast('Kunne ikke oprette medarbejderen.');
        setSyncState('error');
      }
    }

    async function saveEmployee(id, payload) {
      const existing = state.employees.get(id);
      const merged = normaliseEmployee({ ...existing, ...payload, id });
      state.employees.set(id, merged);
      renderEmployees();
      persistLocalState();
      if (!window.db) {
        setSyncState('offline');
        return;
      }
      await window.db.collection('companies').doc(orgId).collection('employees').doc(id).set({
        ...payload,
        updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
      }, { merge: true });
    }

    async function deleteEmployee(id) {
      state.employees.delete(id);
      renderEmployees();
      persistLocalState();
      if (!window.db) {
        setSyncState('offline');
        return;
      }
      await window.db.collection('companies').doc(orgId).collection('employees').doc(id).delete();
    }

    async function updateLeave(id, leave) {
      const employee = state.employees.get(id);
      if (employee) {
        employee.leave = leave ? normaliseLeave(leave) : null;
        state.employees.set(id, employee);
        renderEmployees();
        persistLocalState();
      }
      if (!window.db) {
        setSyncState('offline');
        return;
      }
      await window.db.collection('companies').doc(orgId).collection('employees').doc(id).set({
        leave: leave ? {
          type: leave.type,
          start: leave.start ? window.firebase.firestore.Timestamp.fromDate(leave.start) : null,
          end: leave.end ? window.firebase.firestore.Timestamp.fromDate(leave.end) : null,
        } : null
      }, { merge: true });
    }

    async function notifyHost(host, visitor) {
      const message = `${visitor.name}${visitor.company ? ` fra ${visitor.company}` : ''} er ankommet og venter i receptionen.`;
      try {
        if (window.db) {
          await window.db.collection('companies').doc(orgId).collection('notifications').add({
            type: 'visitor-arrival',
            hostId: host.id,
            hostName: host.name,
            hostEmail: host.email || null,
            hostPhone: host.phone || null,
            visitorName: visitor.name,
            visitorCompany: visitor.company || null,
            visitorPhone: visitor.phone || null,
            message,
            status: 'pending',
            createdAt: window.firebase.firestore.FieldValue.serverTimestamp(),
          });
        }
      } catch (error) {
        console.warn('Kunne ikke sende intern notifikation', error);
      }
      if (host.notifyWebhook) {
        try {
          await fetch(host.notifyWebhook, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: message,
          });
        } catch (error) {
          console.warn('Webhook notifikation fejlede', error);
        }
      }
    }

    async function checkoutVisitor(id) {
      const index = state.visitors.findIndex((visitor) => visitor.id === id);
      if (index === -1) return;
      const now = new Date();
      state.visitors[index] = { ...state.visitors[index], status: 'out', checkedOutAt: now };
      renderVisitors();
      persistLocalState();
      try {
        setSyncState('syncing');
        if (window.db) {
          await window.db.collection('companies').doc(orgId).collection('visitors').doc(id).set({
            status: 'out',
            checkedOutAt: window.firebase.firestore.FieldValue.serverTimestamp(),
          }, { merge: true });
          setSyncState('online');
        } else {
          setSyncState('offline');
        }
        toast('Gæsten er tjekket ud.');
      } catch (error) {
        console.error(error);
        toast('Kunne ikke tjekke gæsten ud.');
        setSyncState('error');
      }
    }

    function escapeCsvValue(value) {
      const text = value === undefined || value === null ? '' : String(value);
      if (/[";\n]/.test(text)) {
        return `"${text.replace(/"/g, '""')}"`;
      }
      return text;
    }

    function downloadCsv(filename, rows) {
      const csv = rows.map((row) => row.map(escapeCsvValue).join(';')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function getPresentEmployees() {
      return [...state.employees.values()].filter((employee) => employee.status === 'in' && !(employee.leave && isOnLeave(employee.leave)));
    }

    function getVisitorsInHouse() {
      return state.visitors.filter((visitor) => visitor.status !== 'out' && !visitor.checkedOutAt);
    }

    function initClock() {
      const timeEl = document.getElementById('clockTime');
      const dateEl = document.getElementById('clockDate');
      function tick() {
        const now = new Date();
        timeEl.textContent = now.toLocaleTimeString('da-DK', { hour: '2-digit', minute: '2-digit' });
        dateEl.textContent = now.toLocaleDateString('da-DK', { weekday: 'long', day: '2-digit', month: 'long' });
      }
      tick();
      setInterval(tick, 30_000);
    }

    function initSlides() {
      buildSlides(state.slides);
    }

    function initFirebase() {
      if (window.WebKioskFirebase) {
        window.firebase = firebase;
        window.db = WebKioskFirebase.db;
        WebKioskFirebase.ready.then(() => {
          attachRealtime();
          setSyncState('online');
        }).catch(() => setSyncState('offline'));
        return;
      }
      const firebaseConfig = {
        apiKey: 'AIzaSyA_gh8y-V6kkl95hRzb0ldBxpKWFY5bAck',
        authDomain: 'webkiosk-e5d32.firebaseapp.com',
        projectId: 'webkiosk-e5d32',
        storageBucket: 'webkiosk-e5d32.firebasestorage.app',
        messagingSenderId: '920175197353',
        appId: '1:920175197353:web:c3520e9a3ab8146ec4fdb8'
      };
      firebase.initializeApp(firebaseConfig);
      window.firebase = firebase;
      window.db = firebase.firestore();
      firebase.auth().signInAnonymously().then(() => {
        attachRealtime();
        setSyncState('online');
      }).catch((error) => {
        console.error(error);
        setSyncState('offline');
      });
    }

    function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js').catch(() => {});
      }
    }

    function init() {
      hydrateFromLocal();
      renderEmployees();
      renderVisitors();
      initClock();
      initSlides();
      initFirebase();
      registerServiceWorker();
      showScreensaver();
    }

    window.addEventListener('load', init);
  </script>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</body>
</html>
